[gd_scene load_steps=10 format=3 uid="uid://cwjb1imduvk04"]

[ext_resource type="Script" path="res://core/player/player.gd" id="1_if8um"]
[ext_resource type="Resource" uid="uid://bn1oi81qkphlm" path="res://core/playback.tres" id="2_nwl3h"]
[ext_resource type="PackedScene" uid="uid://dbitt37u6u746" path="res://core/data_base_holder.tscn" id="3_plvy5"]
[ext_resource type="Script" path="res://gui/panel_control/panel_control.gd" id="5_4umh2"]
[ext_resource type="PackedScene" uid="uid://cp0o32wj18o0x" path="res://gui/player_panel/player_panel.tscn" id="5_nwobq"]
[ext_resource type="PackedScene" uid="uid://mqs6rjv3osx0" path="res://gui/track_list/track_list.tscn" id="6_cwg7h"]
[ext_resource type="StyleBox" uid="uid://cyvqocfgjh0ll" path="res://gui/background.stylebox" id="7_kni80"]

[sub_resource type="GDScript" id="GDScript_pp3fc"]
script/source = "extends Node

@export var playback : Playback

var time : float


func _notification(what: int) -> void:
	match what:
		NOTIFICATION_READY:
			var bytes := FileAccess.get_file_as_bytes('%s/window_data' % OS.get_user_data_dir())
			var template := {
				position = TYPE_VECTOR2I,
				size = TYPE_VECTOR2I,
				always_on_top = TYPE_BOOL,
				track_key = TYPE_INT,
				progress = TYPE_FLOAT,
				playing = TYPE_BOOL,
			}
			if G.validate(bytes_to_var(bytes), template):
				var data := bytes_to_var(bytes) as Dictionary
				var w := get_window()
				w.position = data.position
				w.size = data.size
				w.always_on_top = data.always_on_top
				if playback:
					if playback.current_source and playback.current_source.get_root():
						var track := playback.current_source.get_root()._key_to_track.get(data.track_key, null) as DataBase.Track
						if track:
							playback.play(0, track)
							playback.set_progress(data.progress)
							if not data.playing:
								playback.pause()
		
		NOTIFICATION_WM_CLOSE_REQUEST:
			save()

func _process(delta: float) -> void:
	time += delta
	if time > 1:
		time = 0
		save()

func save() -> void:
	var w := get_window()
	var track_key : int = 0
	var progress : float = 0
	var playing : bool = false
	if playback:
		if playback.current_track and playback.current_track.valid:
			track_key = playback.current_track.key
		progress = playback.get_progress()
		playing = playback.is_playing()
	var data := {
		position = w.position,
		size = w.size,
		always_on_top = w.always_on_top,
		track_key = track_key,
		progress = progress,
		playing = playing,
	}
	var f := FileAccess.open('%s/window_data' % OS.get_user_data_dir(), FileAccess.WRITE_READ)
	f.store_buffer(var_to_bytes(data))
"

[sub_resource type="StyleBoxFlat" id="StyleBoxFlat_7mijb"]
bg_color = Color(0.06, 0.06, 0.06, 1)

[node name="Main" type="Node"]
script = SubResource("GDScript_pp3fc")
playback = ExtResource("2_nwl3h")

[node name="Player" type="AudioStreamPlayer" parent="."]
script = ExtResource("1_if8um")
playback = ExtResource("2_nwl3h")

[node name="DataBaseHolder" parent="." instance=ExtResource("3_plvy5")]
load_on_ready = true
update_on_process = true
handle_files_dropped = true
handle_close_requested = true
metadata/_edit_pinned_properties_ = [&"handle_files_dropped", &"update_on_process", &"load_on_ready", &"handle_close_requested"]

[node name="GUI" type="MarginContainer" parent="."]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/margin_left = 0
theme_override_constants/margin_top = 0
theme_override_constants/margin_right = 0
theme_override_constants/margin_bottom = 0
metadata/_edit_lock_ = true

[node name="Panel" type="Panel" parent="GUI"]
layout_mode = 2
theme_override_styles/panel = SubResource("StyleBoxFlat_7mijb")

[node name="VBoxContainer" type="VBoxContainer" parent="GUI"]
layout_mode = 2
theme_override_constants/separation = 8
script = ExtResource("5_4umh2")

[node name="TrackList2" parent="GUI/VBoxContainer" instance=ExtResource("6_cwg7h")]
visible = false
layout_mode = 2
size_flags_vertical = 3
size_flags_stretch_ratio = 99.5862

[node name="PlayerPanel" parent="GUI/VBoxContainer" instance=ExtResource("5_nwobq")]
layout_mode = 2
size_flags_stretch_ratio = 133.333

[node name="TrackList" parent="GUI/VBoxContainer" instance=ExtResource("6_cwg7h")]
layout_mode = 2
size_flags_vertical = 3
size_flags_stretch_ratio = 253.687

[node name="HBoxContainer" type="HBoxContainer" parent="GUI/VBoxContainer"]
layout_mode = 2
size_flags_vertical = 3
size_flags_stretch_ratio = 50.3125
theme_override_constants/separation = 8
script = ExtResource("5_4umh2")

[node name="Control" type="Panel" parent="GUI/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 194.667
theme_override_styles/panel = ExtResource("7_kni80")

[node name="Control2" type="Panel" parent="GUI/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 194.667
theme_override_styles/panel = ExtResource("7_kni80")

[node name="Control3" type="Panel" parent="GUI/VBoxContainer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 3
size_flags_stretch_ratio = 194.667
theme_override_styles/panel = ExtResource("7_kni80")
